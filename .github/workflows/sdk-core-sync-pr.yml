name: sdk-models-sync-pr

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - "crates/core/**"
      - "crates/types/**"
      - "crates/events/**"
      - "crates/trade/**"
      - "crates/identity/**"
      - "crates/events-codec-wasm/**"
      - "crates/xtask/**"
      - "contract/**"
      - ".github/workflows/sdk-core-sync-pr.yml"

jobs:
  sync-models:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: detect sync token
        id: sync_token
        run: |
          if test -n "${{ secrets.RADROOTS_SDK_SYNC_TOKEN }}"; then
            echo "configured=true" >> "$GITHUB_OUTPUT"
          else
            echo "configured=false" >> "$GITHUB_OUTPUT"
          fi

      - name: skip sync when token is unavailable
        if: steps.sync_token.outputs.configured != 'true'
        run: echo "radroots_sdk_sync_token is not configured; skipping sdk sync workflow"

      - name: install rust toolchain
        if: steps.sync_token.outputs.configured == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0

      - name: export ts sdk artifacts
        if: steps.sync_token.outputs.configured == 'true'
        run: |
          export_dir="${{ runner.temp }}/sdk-export"
          for crate_name in \
            radroots-core \
            radroots-types \
            radroots-events \
            radroots-trade \
            radroots-identity \
            radroots-events-codec-wasm; do
            cargo run -q -p xtask -- sdk export-ts-crate --crate "${crate_name}" --out "${export_dir}"
          done
          test -f "${export_dir}/ts/export-manifest.json"

      - name: check required export artifacts
        if: steps.sync_token.outputs.configured == 'true'
        run: |
          test -f "${{ runner.temp }}/sdk-export/ts/packages/core/src/generated/types.ts"
          test -f "${{ runner.temp }}/sdk-export/ts/packages/types/src/generated/types.ts"
          test -f "${{ runner.temp }}/sdk-export/ts/packages/events/src/generated/types.ts"
          test -f "${{ runner.temp }}/sdk-export/ts/packages/trade/src/generated/types.ts"
          test -f "${{ runner.temp }}/sdk-export/ts/packages/events/src/generated/constants.ts"
          test -f "${{ runner.temp }}/sdk-export/ts/packages/events/src/generated/kinds.ts"

      - name: upload sdk export artifact
        if: steps.sync_token.outputs.configured == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sdk-export-ts-bundle
          path: ${{ runner.temp }}/sdk-export/ts

      - name: checkout sdk-typescript
        if: steps.sync_token.outputs.configured == 'true'
        uses: actions/checkout@v4
        with:
          repository: rad-roots-labs/sdk-typescript
          ref: master
          token: ${{ secrets.RADROOTS_SDK_SYNC_TOKEN }}
          path: sdk-typescript
          fetch-depth: 0

      - name: apply generated model artifacts
        if: steps.sync_token.outputs.configured == 'true'
        run: |
          for package in core types events trade identity; do
            src_dir="${{ runner.temp }}/sdk-export/ts/packages/${package}/src/generated"
            if test -d "${src_dir}"; then
              install -d "sdk-typescript/packages/${package}/src/generated"
              rsync -a --delete "${src_dir}/" "sdk-typescript/packages/${package}/src/generated/"
            fi
          done
          wasm_src="${{ runner.temp }}/sdk-export/ts/packages/events-codec-wasm/dist"
          if test -d "${wasm_src}"; then
            install -d sdk-typescript/packages/events-codec-wasm/dist
            rsync -a --delete "${wasm_src}/" sdk-typescript/packages/events-codec-wasm/dist/
          fi

      - name: setup bun
        if: steps.sync_token.outputs.configured == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: validate sdk-typescript
        if: steps.sync_token.outputs.configured == 'true'
        working-directory: sdk-typescript
        run: |
          bun install --frozen-lockfile
          bun run typecheck
          bun run build
          bun run test

      - name: create pull request
        if: steps.sync_token.outputs.configured == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.RADROOTS_SDK_SYNC_TOKEN }}
          path: sdk-typescript
          commit-message: "sdk: sync generated models from rust sdk contract"
          branch: sync/models-${{ github.run_id }}-${{ github.run_attempt }}
          delete-branch: true
          title: "sdk: sync generated models from rust sdk contract"
          body: |
            - sync generated model types for @radroots/core, @radroots/types, @radroots/events, and @radroots/trade
            - sync @radroots/identity generated types when present in rust export output
            - source revision: ${{ github.sha }}
